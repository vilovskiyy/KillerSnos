<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KillerSnos</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --dark-purple: #1a0526;
            --purple: #3a0a4a;
            --light-purple: #5a2d6e;
            --accent-purple: #8a2be2;
            --text-color: #e6e6fa;
            --error-color: #ff4444;
            --success-color: #00C851;
        }
        
        body {
            margin: 0;
            padding: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-purple);
            color: var(--text-color);
        }
        
        .user-panel {
            background-color: var(--purple);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        
        .subscription-info {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0,0,0,0.2);
        }
        
        .subscription-active {
            border-left: 4px solid var(--success-color);
        }
        
        .subscription-inactive {
            border-left: 4px solid var(--error-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--accent-purple);
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--light-purple);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-purple);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:disabled {
            background-color: var(--light-purple);
            cursor: not-allowed;
        }
        
        button:hover:not(:disabled) {
            background-color: #7b2cbf;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
        }
        
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        
        .success {
            background-color: rgba(0, 200, 81, 0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }
        
        .error {
            background-color: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="user-panel">
        <div><i class="fas fa-user"></i> Пользователь: <span id="username">Гость</span></div>
        <div id="subscription-container" class="subscription-info subscription-inactive">
            <div><i class="fas fa-exclamation-circle"></i> Подписка не активна</div>
            <div id="subscription-timer" class="hidden">
                Осталось: <span id="remaining-time">00:00:00</span>
            </div>
        </div>
    </div>

    <div id="key-input-section" class="form-group">
        <label for="access-key-input"><i class="fas fa-key"></i> Ключ доступа</label>
        <input type="text" id="access-key-input" placeholder="Введите ваш ключ доступа">
        <button id="activate-btn" onclick="activateKey()">
            <i class="fas fa-check"></i> Активировать
        </button>
    </div>

    <div id="report-form" class="hidden">
        <div class="form-group">
            <label for="url"><i class="fas fa-link"></i> Ссылка на нарушение</label>
            <input type="url" id="url" placeholder="https://t.me/username/123" required>
        </div>
        
        <div class="form-group">
            <label for="reason"><i class="fas fa-flag"></i> Причина жалобы</label>
            <select id="reason" required>
                <option value="" disabled selected>Выберите причину</option>
                <option value="childAbuse">Жестокое обращение с детьми</option>
                <option value="violence">Насилие</option>
                <option value="pornography">Порнографические материалы</option>
                <option value="spam">Спам</option>
                <option value="copyright">Нарушение авторских прав</option>
                <option value="other">Другое</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="message"><i class="fas fa-comment"></i> Комментарий</label>
            <textarea id="message" rows="3" placeholder="Дополнительная информация (необязательно)"></textarea>
        </div>
        
        <button id="submit-btn" onclick="submitReport()">
            <i class="fas fa-paper-plane"></i> Отправить жалобу
        </button>
    </div>
    
    <div id="status-message" class="status"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        let subscriptionTimer = null;
        let remainingSeconds = 0;
        let currentAccessKey = '';
        
        // Проверка сохраненного ключа при загрузке
        function checkStoredKey() {
            const storedKey = localStorage.getItem('access_key');
            if (storedKey) {
                document.getElementById('access-key-input').value = storedKey;
                verifyAccessKey(storedKey);
            }
        }
        
        // Форматирование времени
        function formatTime(seconds) {
            const days = Math.floor(seconds / 86400);
            seconds %= 86400;
            const hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            
            if (days > 0) {
                return `${days} дней ${hours} часов`;
            }
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        // Обновление таймера
        function updateTimer() {
            if (remainingSeconds <= 0) {
                clearInterval(subscriptionTimer);
                showSubscriptionStatus(false);
                return;
            }
            
            remainingSeconds--;
            document.getElementById('remaining-time').textContent = formatTime(remainingSeconds);
        }
        
        // Показать статус подписки
        function showSubscriptionStatus(isActive, data = null) {
            const subContainer = document.getElementById('subscription-container');
            const keyInput = document.getElementById('key-input-section');
            const reportForm = document.getElementById('report-form');
            
            if (isActive && data) {
                subContainer.className = 'subscription-info subscription-active';
                subContainer.innerHTML = `
                    <div><i class="fas fa-check-circle"></i> Подписка активна</div>
                    <div>До: ${new Date(data.subscription_end).toLocaleString('ru-RU')}</div>
                    <div id="subscription-timer">
                        Осталось: <span id="remaining-time">${formatTime(data.remaining_seconds)}</span>
                    </div>
                `;
                
                remainingSeconds = data.remaining_seconds;
                if (subscriptionTimer) clearInterval(subscriptionTimer);
                subscriptionTimer = setInterval(updateTimer, 1000);
                
                keyInput.classList.add('hidden');
                reportForm.classList.remove('hidden');
            } else {
                subContainer.className = 'subscription-info subscription-inactive';
                subContainer.innerHTML = '<div><i class="fas fa-exclamation-circle"></i> Подписка не активна</div>';
                
                keyInput.classList.remove('hidden');
                reportForm.classList.add('hidden');
                
                if (subscriptionTimer) {
                    clearInterval(subscriptionTimer);
                    subscriptionTimer = null;
                }
            }
        }
        
        // Проверка ключа доступа
        async function verifyAccessKey(key) {
            const btn = document.getElementById('activate-btn');
            const statusEl = document.getElementById('status-message');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner loading"></i> Проверка...';
            statusEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/check_key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: key
                    })
                });
                
                const data = await response.json();
                
                if (data.valid) {
                    currentAccessKey = key;
                    localStorage.setItem('access_key', key);
                    showSubscriptionStatus(true, data);
                    showStatus('Ключ успешно подтвержден', 'success');
                } else {
                    showStatus(data.message || 'Неверный ключ доступа', 'error');
                }
            } catch (e) {
                showStatus('Ошибка при проверке ключа', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Активировать';
            }
        }
        
        // Активация ключа
        async function activateKey() {
            const key = document.getElementById('access-key-input').value.trim();
            if (!key) {
                showStatus('Введите ключ доступа', 'error');
                return;
            }
            
            await verifyAccessKey(key);
        }
        
        // Отправка жалобы
        async function submitReport() {
            const url = document.getElementById('url').value;
            const reason = document.getElementById('reason').value;
            const message = document.getElementById('message').value;
            const btn = document.getElementById('submit-btn');
            const statusEl = document.getElementById('status-message');
            
            if (!url || !reason) {
                showStatus('Заполните обязательные поля', 'error');
                return;
            }
            
            if (reason === 'other' && !message) {
                showStatus('Для причины "Другое" укажите комментарий', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner loading"></i> Отправка...';
            statusEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: currentAccessKey,
                        url: url,
                        reason: reason,
                        message: message
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(
                        `Жалоба отправлена! Успешно: ${data.success_count}, Ошибок: ${data.failed_count}`,
                        'success'
                    );
                    document.getElementById('url').value = '';
                    document.getElementById('reason').value = '';
                    document.getElementById('message').value = '';
                } else {
                    showStatus(`Ошибка: ${data.message || 'Неизвестная ошибка'}`, 'error');
                }
            } catch (e) {
                showStatus(`Ошибка при отправке: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить жалобу';
            }
        }
        
        // Показать статусное сообщение
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        // Инициализация при загрузке
        tg.ready();
        
        // Установка имени пользователя
        const user = tg.initDataUnsafe.user;
        if (user) {
            document.getElementById('username').textContent = 
                user.username ? `@${user.username}` : user.first_name || 'Пользователь';
        }
        
        // Проверка сохраненного ключа
        checkStoredKey();
    </script>
</body>
</html>
